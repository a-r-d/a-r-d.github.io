I"+<p>Previously I looked at how you can use Apache2 as a reverse proxy with SSL to expose applications inside of your firewall securely from one endpoint with a single SSL cert. Most corporate IT networks will be using a Windows domain controller so next you may be wondering how to secure your intranet pages using Microsoft AD LDAP authentication via Apache2.</p>

<p>It is actually quite do-able although the config takes some effort. First you will want to enable the module “mod_authnz_ldap”. If using ubunutu you can do:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo a2enmod authnz_ldap
</code></pre></div></div>

<p>Now that that is done lets take stock your your AD Domain. Let’s say that your company is called “Mr Waffles” and your domain was called “MRWAFFLES” and then the FQDN was set up as mrwaffles.ad.com on your Active Directory server. This means your base DN is likely “DC=mrwaffles, DC=ad, DC=com”. Okay, now your users are perhaps stored under Organization Unit “Users” (“OU=Users”). So this would make the search container: “OU=Users,DC=mrwaffles, DC=ad, DC=com”. To Recap:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Domain: MRWAFFLES
FQDN: mrwaffles.ad.com
Base Dn: "DC=mrwaffles,DC=ad,DC=com"
User container: "OU=Users,DC=mrwaffles,DC=ad,DC=com"
</code></pre></div></div>

<p>Alright, now that we know what our AD Server looks like we can continue. Personally I am using this for a reverse proxy server so I have a proxy pass in my Location tag. But you can ignore this if you like. Before I show you what you came for let me explain some things:</p>

<ul>
  <li>
    <p>mod_authnz_ldap uses a user to bind that is NOT the one logging in. Create a user with read privs on AD for this purpose. I called mine “authuser” and set a password of “authuserpass”.</p>
  </li>
  <li>
    <p>For the authuser - make sure to put the domain in front of the name for the bind!!! (see AuthLDAPBindDN below)</p>
  </li>
  <li>
    <p>The “?sAMAccountName?sub?(objectClass=*)” is the search query and is absolutely required. I can confirm this works on win2k12 AD domain controller</p>
  </li>
  <li>
    <p>You can filter on groups, I just did any user.</p>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Order deny,allow
Deny from All

AuthBasicProvider ldap
AuthType Basic
AuthName "MR Waffles Network Auth Required"

AuthzLDAPAuthoritative off
AuthLDAPURL "ldap://domain-controller-ip-here:389/ou=Users,dc=mrwaffles,dc=ad,dc=com?sAMAccountName?sub?(objectClass=*)"    

AuthLDAPBindDN "mrwaffles\\authuser"
AuthLDAPBindPassword "authuserpass"

Require valid-user
Satisfy any

ProxyPass  http://internal-ip-here/
ProxyPassReverse  http://internal-ip-here/
</code></pre></div></div>

<p>One more note. This is just basic auth, not form based so it has some downsides of course. Also note when you login you just put in username and pass, not domain prefix, not email, just username.</p>

<p>You may also be interested in see how you do this with PHP. First install the module you need:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get install php5-ldap
</code></pre></div></div>

<p>An equivalent login would be:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">authAD</span><span class="p">(</span> <span class="nx">$usr</span><span class="p">,</span> <span class="nx">$pass</span> <span class="p">){</span>
	<span class="nb">global</span> <span class="nx">$message</span><span class="p">;</span>
	<span class="nx">$ad</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">YOUR DOMAIN CONTROLLER IP</span><span class="dl">"</span><span class="p">;</span>
	<span class="nx">$cxn</span> <span class="o">=</span> <span class="nx">ldap_connect</span><span class="p">(</span><span class="nx">$ad</span><span class="p">);</span>
	<span class="nx">$domain</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">YOUR DOMAIN</span><span class="se">\\</span><span class="dl">"</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="nx">$usr</span> <span class="o">==</span> <span class="dl">""</span> <span class="o">||</span> <span class="nx">$pass</span> <span class="o">==</span> <span class="dl">""</span> <span class="p">){</span>
	    <span class="nx">$message</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">username / pass not set</span><span class="dl">"</span><span class="p">;</span>
	    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nx">$ldap_usr</span> <span class="o">=</span> <span class="nx">$domain</span><span class="p">.</span><span class="dl">""</span><span class="p">.</span><span class="nx">$usr</span><span class="p">;</span>
	<span class="nx">$ldap_pass</span> <span class="o">=</span> <span class="nx">$pass</span><span class="p">;</span>
	<span class="nx">$bind</span> <span class="o">=</span> <span class="nx">ldap_bind</span><span class="p">(</span><span class="nx">$cxn</span><span class="p">,</span> <span class="nx">$ldap_usr</span><span class="p">,</span> <span class="nx">$ldap_pass</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="nx">$bind</span><span class="p">){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">$message</span> <span class="o">=</span>  <span class="dl">"</span><span class="s2">Authentication failed</span><span class="dl">"</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As you can see it is waaaaay simple with PHP. They are just doing a simple bind.</p>
:ET