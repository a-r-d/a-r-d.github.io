I"ß5<h3 id="generating-signed-access-tokens">Generating Signed Access Tokens</h3>

<p>Building simple access tokens a very common task when building an API. It is also a good topic for an interview question. In addition to a general authentication token, you may need to generate any number of other tokens including tokens for password resets, email verifications or api keys. A very interesting kind of access token is on that stores data that signed with a secret key. This actually allows you pass around data that cannot be tampered with and it keeps you from having to store the token in the database.</p>

<h3 id="hash-based-message-authentication">Hash Based Message Authentication</h3>

<p>What I have just described above is actually something called HMAC - hash message authentication code. It is a very simple algorithm which we will implement below.</p>

<h3 id="how-does-it-work">How Does It Work?</h3>

<p>In simple terms you have a secret key that you store on your server, some data that you want to build into the token and a signature created from these parts. Later, you will decode the data and signature and try to rebuild the token from these parts with your secret key. If it matches, your access token is valid. The coolest thing is that you can store an expiration time, a user id, an email - basically any piece of extra data on your token. Again, all of this is achieved securely without any database required.</p>

<h3 id="the-secret-key">THE SECRET KEY</h3>

<p>It can be as simple as a random string in a config file like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var secret = 'skKaTT2dJRXSH3sMxkZ2aWY95jfTeX';  
</code></pre></div></div>

<p>Making it very very long is pointless because any HMAC algorithm will shorten it to a specific length.</p>

<h3 id="building-the-token-data">BUILDING THE TOKEN DATA</h3>

<p>In this example, we are going to build the body as a JSON object, stringify it, and encode it as base64. This way it should be safe to pass as a URL parameter if need be.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>  
    <span class="na">expires</span><span class="p">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">EjuKNCcMjUaxk</span>
<span class="p">};</span>

<span class="c1">// encode it as base64 so it is HTTP safe.</span>
<span class="kd">var</span> <span class="nx">tokendata</span> <span class="o">=</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>  </code></pre></figure>

<h3 id="building-the-signature">BUILDING THE SIGNATURE</h3>

<p>This is the root the work - the HMAC algorithm. It is essentially a function that takes 3 arguments: the key, the data, and the hashing algorithm you will use. There actually a ton of very nice javascript implementations here. And if you read the article it states that it is sufficient to do something like var sig = sha1(key + sha1(key + message)) and the key padding is not critical to security. Needless to say, we will not re-implement HMAC to RFC spec mainly because it is a bit of a pain to do with browser-based javascript.</p>

<h3 id="testing-it-out">TESTING IT OUT</h3>

<p><a href="http://jsbin.com/jaleyewudo/1/embed?html,js,console">Here is a jsbin where you can see the HMAC system in action</a>. We generate a signed token that stores some information and then later we are able to parse the information back out of the token. In this way you can create that tokens that have expiration dates and pass other information all without using a database. Make sure not to store any secret information on the message as it is still visible, just not possible to tamper with!</p>

<h3 id="full-code-copy-of-what-is-on-jsbin">Full code, copy of what is on jsbin</h3>

<p>Here is a copy of the HTML + JS that you need to see this working, in case the JSBin link did not work for whatver reason</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>JS Bin<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/hmac-sha1.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;/body&gt;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// secret HMAC key</span>
<span class="kd">var</span> <span class="nx">secret</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">skKaTT2dJRXSH3sMxkZ2aWY95jfTeX</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="na">expires</span><span class="p">:</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1000</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">,</span>
    <span class="na">userId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">EjuKNCcMjUaxk</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">randomData</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span>
<span class="p">};</span>
<span class="c1">// encode it as base64 so it is HTTP safe.</span>
<span class="kd">function</span> <span class="nx">createTokenData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">btoa</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">tokendata64</span> <span class="o">=</span> <span class="nx">createTokenData</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Token Data: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">tokendata64</span><span class="p">);</span>

<span class="c1">// note that I have included SHA1 HMAC creator from here:</span>
<span class="c1">// http://code.google.com/p/crypto-js/</span>
<span class="kd">function</span> <span class="nx">hmac_sha1</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//console.log('Creating HMAC for message: ' + message);</span>
  <span class="k">return</span> <span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">HmacSHA1</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">key</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// this takes strings</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Computing HMAC...</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">hmac_sha1</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nx">tokendata64</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">The signature: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">signature</span><span class="p">);</span>

<span class="c1">// token delimeter will be a tilda. It should be safe in a GET query param</span>
<span class="kd">var</span> <span class="nx">accesstoken</span> <span class="o">=</span> <span class="nx">signature</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">~</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">tokendata64</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Our access token: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">accesstoken</span><span class="p">);</span>

<span class="c1">// We will pull the data backout into a javascript object</span>
<span class="c1">// and check to see if the signature is valid!</span>
<span class="kd">function</span> <span class="nx">parseToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secretkey</span><span class="p">){</span>
  <span class="c1">// split by token delimeter</span>
  <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">~</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="kd">var</span> <span class="nx">verifysig</span> <span class="o">=</span> <span class="nx">hmac_sha1</span><span class="p">(</span><span class="nx">secretkey</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">tokenInformation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">atob</span><span class="p">(</span><span class="nx">data</span><span class="p">)),</span>
    <span class="na">signature</span><span class="p">:</span> <span class="nx">signature</span><span class="p">,</span>
    <span class="na">valid</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">};</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">signature</span> <span class="o">===</span> <span class="nx">verifysig</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tokenInformation</span><span class="p">.</span><span class="nx">valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">tokenInformation</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parseToken</span><span class="p">(</span><span class="nx">accesstoken</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Parsed token Data: </span><span class="dl">'</span><span class="p">,</span> <span class="nx">parsed</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Parsed token has a valid signature!</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

:ET